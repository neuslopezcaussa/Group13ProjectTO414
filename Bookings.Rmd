---
title: "Untitled"
author: "Jan Láža"
date: "4/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Let's import and understand the data
```{r}
bookings <- read.csv("bookings.csv")
str(bookings)
summary(bookings)

## This dataset is extracted from a hotel group and it explains its bookings and its characteristics. The main goal of this analysis is to optimize the reservations by predicting when the reservation will be canceled. This dataset consists of 32 variables that include integers and factors.

```

## 2. Data cleaning
```{r}
# Solving NAs:
bookings$children <- ifelse(is.na(bookings$children),0,bookings$children)

# Simplyfing the dataset:
## 1. There are 334 levels for the variable agent. We will keep only the top 5 levels.
bookings$agent <- as.character(bookings$agent)
bookings$agent.s <- ifelse(bookings$agent == "9", "9", ifelse(bookings$agent == "240", "240", ifelse(bookings$agent == "NULL", "NULL", ifelse(bookings$agent == "1", "1", ifelse(bookings$agent == "14", "14", "Others")))))
bookings$agent.s <- as.factor(bookings$agent.s)

## 2. There are 353 levels for the variable company. We will keep only the top levels. NULL, 40, 223, 67, 45
bookings$company <- as.character(bookings$company)
bookings$company.s <- ifelse(bookings$company == "NULL", "NULL", ifelse(bookings$company == "40", "40", ifelse(bookings$company == "223", "223", ifelse(bookings$company == "67", "67", ifelse(bookings$company == "45", "45", "Others")))))
bookings$company.s <- as.factor(bookings$company.s)


## 3. There are 178 levels for the variable country. We will group them by region.

#most of the tourist come from Europe so we decided to focus on Europe 
levels(bookings$country) <- list( Southern_Europe= c("PRT","ESP","ITA"), Western_Europe =  c("GBR " , "IRL",  "FRA " ,  "CHE" , "BEL" ,  "NLD",  "LUX"), Cental_Europe = c("DEU",  "AUT" , "POL" ,  "HUN" , "CZE"), Northern_Europe = c("FIN" , "DNK", "SWE","NOR" ), Eastern_Europe= c("ROU","EST", "LTU","BGR", "UKR"), Eastern_Asia = c("CN", "CHN", "JPN", "KOR", "THA", "TWN","HKG "), Middle_East =c("ISR", "EGY", "JOR", "QAT", "OMN"), North_America = ("USA"), South_America =c("BRA","ARG","MEX", "URY" ))


#bookings$country <- ifelse(is.na(bookings$country),"Rest of the World",bookings$country)
#levels(bookings$country) = list(Southern_Europe = "1" ,Western_Europe ="2", Northern_Europe="3", Cental_Europe ="4", Eastern_Europe="5", Eastern_Asia="6",  Middle_East ="7", North_America ="8", South_America ="9", Rest_of_the_World=" Rest of the World")


summary(bookings$country)
                                                                                                                                                          
## 4. Turning the variables children and babys to a 0/1 if they have or not
#babies
bookings$babies <- as.character(bookings$babies)
bookings$babies.s <- ifelse(bookings$babies == "0", "No", "Yes")
bookings$babies.s <- as.factor(bookings$babies.s)

#children
bookings$children <- as.character(bookings$children)
bookings$children.s <- ifelse(bookings$children == "0", "No", "Yes")
bookings$children.s <- as.factor(bookings$children.s)

#delete columns that have been replaced 
bookings$children <- NULL
bookings$babies <- NULL
                          
## Splitting data into training and test sets for speed and prediction
library(caTools)
set.seed(123)
split <- sample.split(bookings$is_canceled, SplitRatio = 0.3)
training_set <- subset(bookings, split == TRUE)
test_set <- subset(bookings, split == FALSE)


#bookings$babies <- as.factor(bookings$babies) factor with ONE LEVEL, with/without babies





```

## 3. Building the model
```{r}
## We will analyze the variable is_canceled. To do so we will do it by using a glm.

### We can see that there are two different types of variables. First, we will analyze the ones that are related to the person itself:
model1 <- glm(is_canceled ~ adults + children + babies + market_segment + distribution_channel + is_repeated_guest + previous_cancellations + previous_bookings_not_canceled + customer_type, family = binomial, data = training_set)
summary(model1)

### Secondly, we will analyze the impact of the variables related to the reservation:
model2 <- glm(is_canceled ~ lead_time + arrival_date_week_number + stays_in_weekend_nights + stays_in_week_nights + meal  + reserved_room_type + assigned_room_type + booking_changes + deposit_type + agent + company + days_in_waiting_list + required_car_parking_spaces + total_of_special_requests, family = binomial, data = training_set)
summary(model2)

model3 <- lm(booking_changes ~  arrival_date_month+lead_time+adults+ children+babies+meal+distribution_channel+reserved_room_type+customer_type, data = training_set)
summary(model3)

```

